<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safepath</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        body { margin:0; background:#f4f4f4; font-family:Arial, sans-serif; }
        header { background:#2c3e50; padding:20px; color:#fff; text-align:center; }
        .container { display:flex; height:calc(100vh - 80px); }
        .sidebar { width:310px; background:#fff; padding:20px; overflow-y:auto; box-shadow:2px 0 5px rgba(0,0,0,.15); }
        .map { flex:1; height:100%; }
        input { width:100%; padding:10px; margin:10px 0; border-radius:4px; border:1px solid #ccc; }
        button { width:100%; padding:12px; background:#3498db; border:none; color:#fff; cursor:pointer; border-radius:4px; margin-bottom:10px; }
        button:hover:not(:disabled) { background:#2980b9; }
        button:disabled { background:#95a5a6; cursor:not-allowed; }
        #travel-info { padding:10px; background:#f8f9fa; border-radius:4px; margin-bottom:10px; }
        .route-option { padding:10px; margin:5px 0; background:#ecf0f1; border-radius:4px; cursor:pointer; }
        .route-option:hover { background:#d5dbdb; }
        .route-option.selected { background:#2c3e50; color:#fff; }
        #crime-stats { margin-top:20px; padding:10px; background:#e8f4fd; border-radius:4px; }
    </style>
</head>
<body>
<header>
    <h1>Safepath</h1>
    <p>Safest route planning using real-time or mock crime data</p>
</header>

<div class="container">
    <div class="sidebar">
        <input id="start" placeholder="Start (e.g., UCLA)">
        <input id="end" placeholder="Destination (e.g., ASU)">
        <button id="findBtn" onclick="findPaths()">Find Paths</button>
        <div id="travel-info"></div>
        <div id="routes"></div>
        <div id="crime-stats"></div>
    </div>
    <div id="map" class="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>
/* ===============================
   CONFIG – NO API KEY NEEDED
   =============================== */
const OSRM_URL = "https://router.project-osrm.org/route/v1/driving";

/* ===============================
   MOCK CRIME DATA
   =============================== */
const mockCrimes = [
    { lat: 34.0689, lng: -118.4452, type: "Theft", desc: "UCLA Campus Theft" },
    { lat: 34.0522, lng: -118.2437, type: "Burglary", desc: "Los Angeles Burglary" },
    { lat: 33.4484, lng: -112.0740, type: "Robbery", desc: "Phoenix Robbery" },
    { lat: 33.4242, lng: -111.9281, type: "Assault", desc: "Tempe Assault" }
];

/* ===============================
   GLOBALS
   =============================== */
let map, routeLayer, crimeMarkers = [];

/* ===============================
   MAP INIT
   =============================== */
function initMap() {
    map = L.map("map").setView([37.0902, -95.7129], 4);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
    }).addTo(map);
}

/* ===============================
   GEOCODING (Nominatim – public)
   =============================== */
async function geocode(query) {
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("Geocoding failed");
    const data = await res.json();
    if (!data.length) throw new Error("Location not found: " + query);
    return { lat: +data[0].lat, lng: +data[0].lon };
}

/* ===============================
   OSRM ROUTING (public, no key)
   =============================== */
async function getRoute(start, end) {
    const url = `${OSRM_URL}/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;
    const res = await fetch(url);
    if (!res.ok) {
        const txt = await res.text();
        throw new Error(`OSRM Error ${res.status}: ${txt}`);
    }
    const json = await res.json();
    if (!json.routes || !json.routes.length) throw new Error("No route found");
    return json.routes[0];
}

/* ===============================
   SAFETY SCORE
   =============================== */
function getSafetyScore(coords) {
    const line = turf.lineString(coords.map(c => [c[0], c[1]])); // [lng, lat]
    let score = 0;
    mockCrimes.forEach(c => {
        const dist = turf.distance(turf.point([c.lng, c.lat]), line, { units: "kilometers" });
        if (dist < 1) score++;
    });
    return score;
}

/* ===============================
   MARKERS
   =============================== */
function addCrimeMarkers() {
    crimeMarkers.forEach(m => map.removeLayer(m));
    crimeMarkers = [];
    mockCrimes.forEach(c => {
        const marker = L.circleMarker([c.lat, c.lng], {
            radius: 6,
            color: "#e74c3c",
            fillOpacity: 0.8
        }).addTo(map).bindPopup(`<b>${c.type}</b><br>${c.desc}`);
        crimeMarkers.push(marker);
    });
}

/* ===============================
   DRAW ROUTE (BLACK LINE)
   =============================== */
function drawRoute(route) {
    if (routeLayer) map.removeLayer(routeLayer);
    
    const coords = route.geometry.coordinates.map(c => [c[1], c[0]]); // [lng,lat] → [lat,lng]
    routeLayer = L.polyline(coords, {
        color: "black",
        weight: 6,
        opacity: 0.9
    }).addTo(map);
    
    map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
}

/* ===============================
   MAIN FUNCTION
   =============================== */
async function findPaths() {
    const startInput = document.getElementById("start");
    const endInput = document.getElementById("end");
    const startText = startInput.value.trim() || startInput.placeholder;
    const endText = endInput.value.trim() || endInput.placeholder;

    const btn = document.getElementById("findBtn");
    btn.disabled = true;
    btn.textContent = "Loading...";

    try {
        const start = await geocode(startText);
        const end = await geocode(endText);

        addCrimeMarkers();
        const route = await getRoute(start, end);
        drawRoute(route);

        const distKm = (route.distance / 1000).toFixed(1);
        const durationMin = Math.round(route.duration / 60);
        const hrs = Math.floor(durationMin / 60);
        const mins = durationMin % 60;
        const safety = getSafetyScore(route.geometry.coordinates);

        document.getElementById("travel-info").innerHTML = `
            <strong>Travel Time:</strong> ${hrs ? hrs + " hr " : ""}${mins} min<br>
            <strong>Distance:</strong> ${distKm} km<br>
            <strong>Crimes Near Route:</strong> ${safety}
        `;

        document.getElementById("crime-stats").innerHTML = `
            <strong>Crime Stats:</strong><br>
            ${mockCrimes.length} demo incidents loaded.
        `;

    } catch (e) {
        alert("Error: " + e.message);
        console.error(e);
    } finally {
        btn.disabled = false;
        btn.textContent = "Find Paths";
    }
}

/* ===============================
   INIT
   =============================== */
window.onload = initMap;
</script>
</body>
</html>
